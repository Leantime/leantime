leantime.calendarController=function(){var f=function(r){var i=new Date;i.getDate(),i.getMonth(),i.getFullYear();var l=document.body.offsetHeight-260,n=document.querySelector("#calendar"),a=new FullCalendar.Calendar(n,{timeZone:leantime.i18n.__("usersettings.timezone"),height:l,headerToolbar:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek,timeGridDay,listDay"},titleFormat:{year:"numeric",month:"long"},dayHeaderFormat:{weekday:"short"},eventTimeFormat:leantime.dateHelper.getFormatFromSettings("timeformat","luxon"),direction:leantime.i18n.__("language.isRTL")=="false"?"ltr":"rtl",firstDay:parseInt(leantime.i18n.__("language.firstDayOfWeek"),10),locale:leantime.i18n.__("language.code"),buttonText:{today:leantime.i18n.__("buttons.today"),month:leantime.i18n.__("buttons.month"),week:leantime.i18n.__("buttons.week"),day:leantime.i18n.__("buttons.day")},selectable:!0,select:function(t){var d=prompt(leantime.i18n.__("label.event_title"));d&&a.addEvent({title:d,start:t.start,end:t.end,allDay:t.allDay}),a.unselect()},events:r,eventColor:"#0866c6"});a.render()},p=function(){document.addEventListener("DOMContentLoaded",function(){Date.prototype.addDays=function(t){return this.setDate(this.getDate()+t),this};var r=leantime.dateHelper.getFormatFromSettings("dateformat","flatpickr"),i=document.querySelector("#event_date_from"),l=document.querySelector("#event_date_to"),n=flatpickr(i,{dateFormat:r,locale:{firstDayOfWeek:parseInt(leantime.i18n.__("language.firstDayOfWeek"),10)},allowInput:!0,onOpen:function(t,d,u){if(u.element.hasAttribute("readonly"))return u.close(),!1},onChange:function(t,d){t.length>0&&a.set("minDate",t[0]),l.value===""&&a.setDate(t[0],!0)}}),a=flatpickr(l,{dateFormat:r,locale:{firstDayOfWeek:parseInt(leantime.i18n.__("language.firstDayOfWeek"),10)},allowInput:!0,onChange:function(t){t.length>0&&n.set("maxDate",t[0])}})})},y=function(){var r={sizes:{minW:400,minH:350},resizable:!0,autoSizable:!0,callbacks:{afterShowCont:function(){jQuery(".formModal").nyroModal(r)},beforeClose:function(){location.reload()}},titleFromIframe:!0};jQuery(".exportModal").nyroModal(r)},h=function(r,i){let l=document.querySelector(r),n=leantime.dateHelper.getFormatFromSettings("dateformat","luxon"),a=leantime.dateHelper.getFormatFromSettings("timeformat","luxon");const t=new FullCalendar.Calendar(l,{timeZone:leantime.i18n.__("usersettings.timezone"),height:"calc(100% - 65px)",stickyHeaderDates:!0,initialView:i,eventStartEditable:!0,dayHeaderFormat:n,eventTimeFormat:a,slotLabelFormat:a,views:{multiMonthOneMonth:{type:"multiMonth",duration:{months:1},multiMonthTitleFormat:{month:"long",year:"numeric"},dayHeaderFormat:{weekday:"short"}},timeGridDay:{dayHeaders:!1},listWeek:{listDayFormat:{weekday:"long"},listDaySideFormat:leantime.dateHelper.getFormatFromSettings("dateformat","luxon")}},droppable:!0,eventSources,editable:!0,headerToolbar:!1,nowIndicator:!0,eventDrop:function(e){e.event.extendedProps.enitityType=="ticket"?fetch(leantime.appUrl+"/api/tickets",{method:"PATCH",credentials:"include",headers:{"Content-Type":"application/x-www-form-urlencoded","X-Requested-With":"XMLHttpRequest"},body:new URLSearchParams({id:e.event.extendedProps.enitityId,editFrom:luxon.DateTime.fromJSDate(e.event.start).toFormat(n),timeFrom:luxon.DateTime.fromJSDate(e.event.start).toFormat(a),editTo:luxon.DateTime.fromJSDate(e.event.end).toFormat(n),timeTo:luxon.DateTime.fromJSDate(e.event.end).toFormat(a)})}):e.event.extendedProps.enitityType=="event"&&fetch(leantime.appUrl+"/api/calendar",{method:"PATCH",credentials:"include",headers:{"Content-Type":"application/x-www-form-urlencoded","X-Requested-With":"XMLHttpRequest"},body:new URLSearchParams({id:e.event.extendedProps.enitityId,dateFrom:e.event.startStr,dateTo:e.event.endStr})})},eventResize:function(e){e.event.extendedProps.enitityType=="ticket"?fetch(leantime.appUrl+"/api/tickets",{method:"PATCH",credentials:"include",headers:{"Content-Type":"application/x-www-form-urlencoded","X-Requested-With":"XMLHttpRequest"},body:new URLSearchParams({id:e.event.extendedProps.enitityId,editFrom:luxon.DateTime.fromJSDate(e.event.start).toFormat(n),timeFrom:luxon.DateTime.fromJSDate(e.event.start).toFormat(a),editTo:luxon.DateTime.fromJSDate(e.event.end).toFormat(n),timeTo:luxon.DateTime.fromJSDate(e.event.end).toFormat(a)})}):e.event.extendedProps.enitityType=="event"&&fetch(leantime.appUrl+"/api/calendar",{method:"PATCH",credentials:"include",headers:{"Content-Type":"application/x-www-form-urlencoded","X-Requested-With":"XMLHttpRequest"},body:new URLSearchParams({id:e.event.extendedProps.enitityId,dateFrom:e.event.startStr,dateTo:e.event.endStr})})},eventReceive:function(e){fetch(leantime.appUrl+"/api/tickets",{method:"PATCH",credentials:"include",headers:{"Content-Type":"application/x-www-form-urlencoded","X-Requested-With":"XMLHttpRequest"},body:new URLSearchParams({id:e.event.id,editFrom:luxon.DateTime.fromJSDate(e.event.start).toFormat(n),timeFrom:luxon.DateTime.fromJSDate(e.event.start).toFormat(a),editTo:luxon.DateTime.fromJSDate(e.event.end).toFormat(n),timeTo:luxon.DateTime.fromJSDate(e.event.end).toFormat(a)})})},eventDragStart:function(e){},eventDidMount:function(e){e.isDraggable===!1&&e.el.classList.add("locked"),e.event.extendedProps.location!=null&&e.event.extendedProps.location!=""&&e.event.extendedProps.location.indexOf("http")==0&&(e.el.setAttribute("href",e.event.extendedProps.location),e.el.setAttribute("target","_blank"))}});document.addEventListener("DOMContentLoaded",function(){var e=document.querySelector("#yourToDoContainer");e&&d(e),u(),t.scrollToTime(Date.now())});function d(e){var c=e;c&&new FullCalendar.ThirdPartyDraggable(c,{itemSelector:".draggable-todo",mirrorClass:"dragging-mirror",eventDragMinDistance:10,mirrorSelector:function(m){return m.closest(".ticketBox")},eventData:function(m){let o=JSON.parse(m.dataset.event);return{id:o.id,title:o.title,color:o.color,enitityType:"ticket",duration:"01:00",url:o.url}}}),t.scrollToTime(Date.now())}function u(){t.setOption("locale",leantime.i18n.__("language.code")),t.render(),t.scrollToTime(Date.now());var e=document.querySelector(".minCalendar .fc-prev-button");e&&e.addEventListener("click",function(){t.prev(),t.getCurrentData()});var c=document.querySelector(".minCalendar .fc-next-button");c&&c.addEventListener("click",function(){t.next()});var m=document.querySelector(".minCalendar .fc-today-button");m&&m.addEventListener("click",function(){t.today()}),document.querySelectorAll(".minCalendar .calendarViewSelect").forEach(function(o){o.addEventListener("click",function(s){console.log(this.dataset.value),t.changeView(this.dataset.value),fetch(leantime.appUrl+"/api/submenu",{method:"PATCH",credentials:"include",headers:{"Content-Type":"application/x-www-form-urlencoded","X-Requested-With":"XMLHttpRequest"},body:new URLSearchParams({submenu:"dashboardCalendarView",state:this.dataset.value})})})}),document.querySelectorAll(".day-button").forEach(function(o){o.addEventListener("click",function(){var s=this.dataset.date;t.gotoDate(s),document.querySelectorAll(".day-button").forEach(function(v){v.classList.remove("active")}),this.classList.add("active")})})}htmx.onLoad(function(e){return e.id=="yourToDoContainer"&&d(e),l})};return{initCalendar:f,initEventDatepickers:p,initExportModal:y,initWidgetCalendar:h}}();
