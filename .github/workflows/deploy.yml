name: Deploy Leantime

on:
  push:
    branches:
      - develop
      - master
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest

    steps:
      - name: Setup SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H $SSH_HOST >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: Deploy to Staging
        if: github.ref == 'refs/heads/develop'
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          STAGING_PATH: ${{ secrets.STAGING_PATH }}
          STAGING_ENV_FILE: ${{ secrets.STAGING_ENV_FILE }}
        run: |
          echo "Deploying to STAGING"

          # Deploy using git pull on server
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST << ENDSSH
            set -e  # Exit on error

            echo "Changing to deployment directory..."
            cd $STAGING_PATH

            echo "Fetching latest changes..."
            git fetch origin develop

            echo "Creating backup tag..."
            BACKUP_TAG="backup-staging-$(date +%Y%m%d_%H%M%S)"
            git tag -f $BACKUP_TAG HEAD
            echo "Backup tag created: $BACKUP_TAG"

            echo "Pulling latest code from develop branch..."
            git pull origin develop

            echo "Installing Composer dependencies..."
            composer install --no-dev --optimize-autoloader --no-interaction

            echo "Installing NPM dependencies..."

            echo "Building frontend assets..."
            npx mix --production

            echo "Generating blocklist..."
            node generateBlocklist.mjs

            echo "Clearing cache..."
            # Clear cache files
            sudo find bootstrap/cache -type f ! -name '.gitignore' -delete 2>/dev/null || true
            sudo find storage/framework/cache -type f ! -name '.gitignore' -delete 2>/dev/null || true
            sudo find storage/framework/sessions -type f ! -name '.gitignore' -delete 2>/dev/null || true
            sudo find storage/framework/views -type f ! -name '.gitignore' -delete 2>/dev/null || true

            echo "Setting proper file permissions..."
            # Set ownership for application files
            sudo chown -R www-data:www-data $STAGING_PATH

            # Secure .env file permissions
            sudo chmod 600 config/.env 2>/dev/null || true

            # Make writable directories
            sudo chmod -R 775 storage bootstrap/cache userfiles public/userfiles 2>/dev/null || true

            echo "Reloading services..."
            # Reload PHP-FPM to clear opcache
            sudo systemctl reload php8.2-fpm

            # Reload nginx
            sudo systemctl reload nginx

            echo "Staging deployment completed successfully!"
            echo "Commit: $(git rev-parse --short HEAD)"
            echo "Rollback available: git reset --hard $BACKUP_TAG"
          ENDSSH

      - name: Health Check Staging
        if: github.ref == 'refs/heads/develop'
        env:
          STAGING_URL: ${{ secrets.STAGING_URL }}
        run: |
          echo " Running staging health check..."
          sleep 3

          response=$(curl -s -o /dev/null -w "%{http_code}" $STAGING_URL/healthCheck.php 2>/dev/null || echo "000")

          if [ "$response" = "200" ]; then
            echo " Staging health check passed! (HTTP $response)"
          else
            echo " Warning: Health check returned HTTP $response"
            echo "Please verify the staging deployment manually at $STAGING_URL"
          fi

      - name: Deploy to Production
        if: github.ref == 'refs/heads/master'
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          PRODUCTION_PATH: ${{ secrets.PRODUCTION_PATH }}
        run: |
          echo "Deploying to PRODUCTION using Git Pull..."

          # Deploy using git pull on server
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST << ENDSSH
            set -e  # Exit on error

            echo "Changing to deployment directory..."
            cd $PRODUCTION_PATH

            echo "Fetching latest changes..."
            git fetch -v origin master

            echo "Creating backup tag..."
            BACKUP_TAG="backup-production-$(date +%Y%m%d_%H%M%S)"
            git tag -f $BACKUP_TAG HEAD
            echo "Backup tag created: $BACKUP_TAG"

            echo "Pulling latest code from master branch..."
            git pull origin master

            echo "Installing Composer dependencies..."
            composer install --no-dev --optimize-autoloader --no-interaction

            echo "Installing NPM dependencies..."
            npm ci

            echo "Building frontend assets..."
            npx mix --production

            echo "Generating blocklist..."
            node generateBlocklist.mjs

            echo "Clearing cache..."
            # Clear cache files
            sudo find bootstrap/cache -type f ! -name '.gitignore' -delete 2>/dev/null || true
            sudo find storage/framework/cache -type f ! -name '.gitignore' -delete 2>/dev/null || true
            sudo find storage/framework/sessions -type f ! -name '.gitignore' -delete 2>/dev/null || true
            sudo find storage/framework/views -type f ! -name '.gitignore' -delete 2>/dev/null || true

            echo "Setting proper file permissions..."
            # Set ownership for application files
            sudo chown -R www-data:www-data $PRODUCTION_PATH

            # Secure .env file permissions
            sudo chmod 600 config/.env 2>/dev/null || true

            # Make writable directories
            sudo chmod -R 775 storage bootstrap/cache userfiles public/userfiles 2>/dev/null || true

            echo "Reloading services..."
            # Reload PHP-FPM to clear opcache
            sudo systemctl reload php8.2-fpm

            # Reload nginx
            sudo systemctl reload nginx

            echo "Production deployment completed successfully!"
            echo "Commit: $(git rev-parse --short HEAD)"
            echo "Rollback available: git reset --hard $BACKUP_TAG"
          ENDSSH

      - name: Health Check Production
        if: github.ref == 'refs/heads/master'
        env:
          PRODUCTION_URL: ${{ secrets.PRODUCTION_URL }}
        run: |
          echo " Running production health check..."
          sleep 5

          response=$(curl -s -o /dev/null -w "%{http_code}" $PRODUCTION_URL/healthCheck.php 2>/dev/null || echo "000")

          if [ "$response" = "200" ]; then
            echo " Production health check passed! (HTTP $response)"
          else
            echo " ERROR: Production health check failed! (HTTP $response)"
            echo " Please verify the deployment manually at $PRODUCTION_URL"
            exit 1
          fi

      - name: Deployment Summary
        if: always()
        run: |
          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          if [ "${{ github.ref }}" = "refs/heads/develop" ]; then
            echo " STAGING Deployment Summary"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo "Branch:      develop"
            echo "Environment: Staging"
            echo "Server:      ${{ secrets.SSH_HOST }}"
            echo "Path:        ${{ secrets.STAGING_PATH }}"
            echo "URL:         ${{ secrets.STAGING_URL }}"
          else
            echo " PRODUCTION Deployment Summary"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo "Branch:      master"
            echo "Environment: Production"
            echo "Server:      ${{ secrets.SSH_HOST }}"
            echo "Path:        ${{ secrets.PRODUCTION_PATH }}"
            echo "URL:         ${{ secrets.PRODUCTION_URL }}"
          fi
          echo "Commit:      ${{ github.sha }}"
          echo "Actor:       ${{ github.actor }}"
          echo "Status:      ${{ job.status }}"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

